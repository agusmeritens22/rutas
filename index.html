<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOLGISTICA · Planificador de Rutas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fuente Questrial -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">

  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.webmanifest?v=15">

  <style>
    /* Base + fondo */
    body{
      font-family:'Questrial', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:url('./fondo.jpg') no-repeat center center fixed;
      background-size:cover;
      color:#0f172a;
    }
    .container{max-width:90rem;margin-left:auto;margin-right:auto}

    /* Glassmorphism cards */
    .card{
      position:relative;
      background:rgba(255,255,255,.15);
      border-radius:1rem;
      border:1px solid rgba(255,255,255,.35);
      box-shadow:0 20px 50px rgba(0,0,0,.2);
      padding:1.25rem;
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
    }
    @media (min-width:640px){ .card{ padding:1.5rem; } }

    /* Botones */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.6rem .9rem;border-radius:1rem;font-weight:600;box-shadow:0 10px 24px rgba(2,6,23,.06);transition:transform .12s ease, box-shadow .2s, filter .2s, background .2s, color .2s}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{color:#fff;background:linear-gradient(135deg,#0ea5e9,#0369a1)}
    .btn-secondary{color:#fff;background:linear-gradient(135deg,#f59e0b,#b45309)}
    .btn-danger{color:#fff;background:linear-gradient(135deg,#ef4444,#b91c1c)}
    .btn-soft{background:#f1f5f9;color:#0f172a}

    /* Auth gate */
    #authGate{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);z-index:9999}
  </style>
</head>
<body class="antialiased">

  <!-- Header (banner opcional) -->
  <header class="relative w-full h-24 sm:h-32 lg:h-48 bg-center bg-cover" style="background-image:url('./banner.png');">
    <div class="relative container flex items-center justify-end h-full px-4 py-3 text-white gap-2">
      <span id="userEmail" class="backdrop-blur-sm bg-white/20 border border-white/30 rounded-full px-3 py-1 text-xs sm:text-sm hidden"></span>
      <button id="signOutBtn" class="btn btn-soft text-xs sm:text-sm hidden">CERRAR SESIÓN</button>
    </div>
  </header>

  <!-- Gate de autenticación -->
  <div id="authGate" class="flex">
    <div class="card w-[90%] max-w-sm text-center m-auto bg-white/30">
      <h2 class="text-lg font-semibold mb-2">Iniciar sesión</h2>
      <p class="text-sm text-slate-700 mb-4">Elegí cómo entrar para usar la app.</p>

      <div class="space-y-2 text-left">
        <label class="block text-sm">Email</label>
        <input id="emailInput" type="email" class="w-full p-2 rounded-xl border border-slate-300" placeholder="tu@email.com" />
        <label class="block text-sm mt-2">Contraseña</label>
        <input id="passInput" type="password" class="w-full p-2 rounded-xl border border-slate-300" placeholder="••••••••" />
      </div>

      <div class="mt-3 grid grid-cols-2 gap-2">
        <button id="emailSignIn" class="btn btn-primary">Entrar</button>
        <button id="emailSignUp" class="btn btn-secondary">Crear cuenta</button>
      </div>
      <button id="emailReset" class="mt-2 text-xs text-sky-700 hover:underline">Olvidé mi contraseña</button>

      <div class="my-4 flex items-center gap-3 text-xs text-slate-400">
        <div class="flex-1 h-px bg-slate-200"></div> o <div class="flex-1 h-px bg-slate-200"></div>
      </div>

      <button id="googleSignIn" class="btn w-full" style="background:#ea4335;color:white;">Entrar con Google</button>
      <p id="authError" class="text-xs text-red-600 mt-3 hidden"></p>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="container p-4 sm:p-6">
    <section class="grid grid-cols-1 xl:grid-cols-12 gap-4 xl:gap-6">
      <!-- IZQUIERDA -->
      <div class="xl:col-span-8 space-y-6">
        <!-- Direcciones / opciones -->
        <div class="card">
          <label for="links" class="block text-sm font-medium mb-2">Direcciones o links (uno por línea):</label>
          <textarea id="links"
            class="w-full h-44 p-4 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-500 text-sm"
            placeholder="Formato recomendado: Local | Dirección&#10;Ej:&#10;La Esquina Market | Buenos Aires 787, B7240 Lobos, BA&#10;Carnicería El Toro | Hipólito Yrigoyen 295, B7240 Lobos, BA"></textarea>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
            <label class="text-sm flex items-center gap-2">
              <input id="autoRun" type="checkbox" class="w-4 h-4 rounded" checked>
              Auto-geocodificar y optimizar
            </label>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="avgSpeed">Velocidad media (km/h):</label>
              <input id="avgSpeed" type="number" min="1" step="1" value="40" class="w-24 p-2 rounded-lg border border-slate-300 text-sm" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="defaultDwell">Estadía por parada (min):</label>
              <input id="defaultDwell" type="number" min="0" step="1" value="10" class="w-24 p-2 rounded-lg border border-slate-300 text-sm" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="startTime">Hora de inicio:</label>
              <input id="startTime" type="time" class="p-2 rounded-lg border border-slate-300 text-sm" value="08:00" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="defaultOpen">Apertura (default):</label>
              <input id="defaultOpen" type="time" class="p-2 rounded-lg border border-slate-300 text-sm" placeholder="08:00" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="defaultClose">Cierre (default):</label>
              <input id="defaultClose" type="time" class="p-2 rounded-lg border border-slate-300 text-sm" placeholder="18:00" />
            </div>
            <label class="text-sm flex items-center gap-2">
              <input id="useGeo" type="checkbox" class="w-4 h-4 rounded">
              Usar mi ubicación como inicio
            </label>
            <label class="text-sm flex items-center gap-2">
              <input id="circular" type="checkbox" class="w-4 h-4 rounded">
              Ruta circular
            </label>
            <label class="text-sm flex items-center gap-2">
              <input id="enforceWindows" type="checkbox" class="w-4 h-4 rounded" checked>
              Respetar ventanas horarias
            </label>
          </div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="oneClick" class="btn btn-primary">Pegar y Optimizar</button>
            <button id="updateBtn" class="btn btn-secondary">Actualizar</button>
            <button id="clearBtn" class="btn btn-soft">Limpiar</button>
          </div>
        </div>

        <!-- Estado / Resultados (debajo a la izquierda) -->
        <div class="card">
          <h3 class="font-semibold mb-2">Estado</h3>
          <div id="status" class="text-xs">Esperando entradas…</div>

          <h3 class="font-semibold mt-4 mb-2">Resultados</h3>
          <div id="results" class="text-sm space-y-2"><p>Aún sin resultados.</p></div>
          <div class="mt-4 flex flex-col gap-2">
            <button id="copyOrder" class="btn btn-soft">Copiar orden</button>
            <button id="exportCsv" class="btn btn-primary">Exportar CSV</button>
            <button id="openInGMaps" class="btn btn-primary">Ver en Google Maps</button>
          </div>
        </div>
      </div>

      <!-- DERECHA -->
      <div class="xl:col-span-4 space-y-6">
        <!-- PUNTOS DETECTADOS (tabla) -->
        <div id="inputTableWrap" class="bg-white rounded-2xl shadow p-4 sm:p-5 hidden">
          <h2 class="text-lg font-semibold mb-3">Puntos detectados</h2>
          <div class="overflow-x-auto">
            <table class="table-auto w-full text-sm bg-white rounded-xl">
              <thead>
                <tr class="text-left text-slate-600">
                  <th class="py-3 px-4">#</th>
                  <th class="py-3 px-4">Local</th>
                  <th class="py-3 px-4 w-full">Dirección</th>
                  <th class="py-3 px-4">Lat</th>
                  <th class="py-3 px-4">Lng</th>
                  <th class="py-3 px-4">Precisión</th>
                  <th class="py-3 px-4">Estadía</th>
                  <th class="py-3 px-4">Abre</th>
                  <th class="py-3 px-4">Cierra</th>
                </tr>
              </thead>
              <tbody id="inputTable"></tbody>
            </table>
          </div>
          <div class="mt-3 text-xs text-slate-500">
            Podés editar <strong>Local</strong>, <strong>Abre/Cierra</strong> y <strong>Estadía</strong>. El cronograma usa estos valores.
          </div>
        </div>

        <!-- Rutas guardadas -->
        <div class="card">
          <h3 class="font-semibold mb-2">Rutas guardadas</h3>
          <div class="grid grid-cols-1 gap-2">
            <input id="routeName" type="text" class="p-2 rounded-lg border border-slate-300 text-sm" placeholder="Nombre de la ruta" />
            <div class="flex flex-wrap gap-2">
              <button id="saveNamed" class="btn btn-primary">Guardar con nombre</button>
              <button id="updateNamed" class="btn btn-soft">Actualizar</button>
              <button id="syncNow" class="btn btn-soft">Sincronizar ahora</button>
            </div>
            <div class="flex items-center gap-2 mt-2">
              <select id="savedSelect" class="flex-1 p-2 rounded-lg border border-slate-300 text-sm"></select>
            </div>
            <div class="flex flex-wrap gap-2 mt-1">
              <button id="loadNamed" class="btn btn-primary">Cargar</button>
              <button id="renameNamed" class="btn btn-soft">Renombrar</button>
              <button id="deleteNamed" class="btn btn-danger">Borrar</button>
              <button id="exportNamed" class="btn btn-soft">Exportar JSON</button>
              <label class="btn btn-soft cursor-pointer">
                Importar JSON
                <input id="importNamed" type="file" accept="application/json" class="hidden" />
              </label>
            </div>
          </div>
        </div>

        <!-- Enlaces de navegación -->
        <div class="card">
          <h3 class="font-semibold mb-2">Enlaces de navegación</h3>
          <div id="dirLinks" class="text-sm space-y-2">
            <p>Se generan links a Google Maps por tramos.</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- App logic -->
  <script src="app.js?v=15"></script>

  <!-- Geocoder -->
  <script>
    window.GEOCODER = { provider: 'opencage', key: 'a24210fb3d144afc8d35ad8d5e339879' };
  </script>

  <!-- Firebase + login -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, inMemoryPersistence,
             GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
             createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const qs = new URLSearchParams(location.search);
    const DEBUG = qs.get('debug') === '1';

    const firebaseConfig = {
      apiKey: "AIzaSyBMo1tBOmXVhY6QwgWbzvfAndltp9k4NZk",
      authDomain: "rutas-da064.firebaseapp.com",
      projectId: "rutas-da064",
      storageBucket: "rutas-da064.appspot.com",
      messagingSenderId: "126930065003",
      appId: "1:126930065003:web:1a40af65ab7f6b9afe832e"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    window._firebase = { db, auth };

    const gate   = document.getElementById('authGate');
    const errEl  = document.getElementById('authError');
    const emailEl= document.getElementById('emailInput');
    const passEl = document.getElementById('passInput');
    const signOutBtn = document.getElementById('signOutBtn');
    const userEmail  = document.getElementById('userEmail');

    function showGate(msg=''){ gate.style.display='flex'; gate.classList.remove('hidden'); if(msg){ errEl.textContent=msg; errEl.classList.remove('hidden'); } }
    function hideGate(){ gate.style.display='none'; gate.classList.add('hidden'); errEl.classList.add('hidden'); errEl.textContent=''; }

    try{
      const isIOS=/iPad|iPhone|iPod/i.test(navigator.userAgent);
      const isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      await setPersistence(auth, (isIOS||isSafari)? inMemoryPersistence : browserLocalPersistence);
    }catch(_){}

    document.getElementById('emailSignIn')?.addEventListener('click', async ()=>{
      try{ await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); hideGate(); }catch(e){ errEl.textContent=e.message; errEl.classList.remove('hidden');}
    });
    document.getElementById('emailSignUp')?.addEventListener('click', async ()=>{
      try{ await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); hideGate(); }catch(e){ errEl.textContent=e.message; errEl.classList.remove('hidden');}
    });
    document.getElementById('emailReset')?.addEventListener('click', async ()=>{
      try{ await sendPasswordResetEmail(auth, emailEl.value.trim()); errEl.textContent='Te enviamos un link para restablecer.'; errEl.classList.remove('hidden'); }catch(e){ errEl.textContent=e.message; errEl.classList.remove('hidden');}
    });

    const provider = new GoogleAuthProvider();
    document.getElementById('googleSignIn')?.addEventListener('click', async ()=>{
      try{ await signInWithPopup(auth, provider); }catch(_){ try{ await signInWithRedirect(auth, provider); }catch(e){ errEl.textContent=e.message; errEl.classList.remove('hidden'); } }
    });

    onAuthStateChanged(auth, (user)=>{
      if(user && !user.isAnonymous){
        if(userEmail){ userEmail.textContent=user.email||'Usuario'; userEmail.classList.remove('hidden'); }
        if(signOutBtn){ signOutBtn.classList.remove('hidden'); }
        hideGate();
        window.cloudSyncToLocal?.();
      }else{
        if(userEmail){ userEmail.classList.add('hidden'); userEmail.textContent=''; }
        if(signOutBtn){ signOutBtn.classList.add('hidden'); }
        showGate();
      }
    });

    signOutBtn?.addEventListener('click', async ()=>{ try{ await signOut(auth); }catch{} });
  </script>

  <!-- SW -->
  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js?v=15'); });
    }
  </script>
</body>
</html>
