<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOLGISTICA ¬∑ Planificador de Rutas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.webmanifest?v=15">
  <style>
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}
    .container{max-width:90rem;margin-left:auto;margin-right:auto}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Encabezado SOLGISTICA con banner responsive -->
  <header class="relative w-full h-24 sm:h-32 lg:h-48 bg-center bg-cover" style="background-image: url('./banner.png');">
    <div class="relative container flex items-center justify-end h-full px-4 py-3 text-white">
      <button class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-xs sm:text-sm">USUARIO1</button>
      <button class="ml-2 px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-xs sm:text-sm">CERRAR SESI√ìN</button>
    </div>
  </header>

  <!-- Hero (texto)  -->
  <div class="px-4 sm:px-6 container mt-3">
    <div class="rounded-xl border border-slate-200 bg-white px-4 py-3">
      <h1 class="text-base sm:text-lg font-semibold">Planificador de Rutas</h1>
      <p class="text-xs sm:text-sm text-slate-600">Optimizaci√≥n con ventanas horarias + guardado en la nube</p>
    </div>
  </div>

  <!-- üîí Gate de autenticaci√≥n (overlay) -->
  <style>
    #authGate { position:fixed; inset:0; background:rgba(0,0,0,0.65); backdrop-filter:blur(2px); z-index:9999; }
  </style>
  <div id="authGate" class="flex">
    <div class="bg-white rounded-xl shadow-xl p-6 w-[90%] max-w-sm text-center m-auto">
      <h2 class="text-lg font-semibold mb-2">Iniciar sesi√≥n</h2>
      <p class="text-sm text-slate-600 mb-4">Debes iniciar sesi√≥n con Google para usar la app.</p>
      <button id="googleSignIn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 w-full">Entrar con Google</button>
      <p id="authError" class="text-xs text-red-600 mt-3 hidden"></p>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="container p-4 sm:p-6">
    <section class="grid grid-cols-1 xl:grid-cols-3 gap-4 xl:gap-6">
      <!-- Columna izquierda: entradas y tabla -->
      <div class="xl:col-span-2 space-y-6">
        <div class="bg-white rounded-2xl shadow p-4 sm:p-5">
          <label for="links" class="block text-sm font-medium mb-2">Direcciones o links (uno por l√≠nea):</label>
          <textarea id="links" class="w-full h-44 p-3 border rounded-xl mono text-sm focus:outline-none focus:ring-2 focus:ring-sky-600" placeholder="Formato recomendado: Local | Direcci√≥n
Ej:
La Esquina Market | Buenos Aires 787, B7240 Lobos, BA
Carnicer√≠a El Toro | Hip√≥lito Yrigoyen 295, B7240 Lobos, BA"></textarea>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
            <label class="text-sm flex items-center gap-2">
              <input id="autoRun" type="checkbox" class="w-4 h-4 rounded" checked>
              Auto-geocodificar y optimizar
            </label>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="avgSpeed">Velocidad media (km/h):</label>
              <input id="avgSpeed" type="number" min="1" step="1" value="40" class="w-24 p-2 border rounded-lg text-sm" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="defaultDwell">Estad√≠a por parada (min):</label>
              <input id="defaultDwell" type="number" min="0" step="1" value="10" class="w-24 p-2 border rounded-lg text-sm" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="startTime">Hora de inicio:</label>
              <input id="startTime" type="time" class="p-2 border rounded-lg text-sm" value="08:00" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="defaultOpen">Apertura (default):</label>
              <input id="defaultOpen" type="time" class="p-2 border rounded-lg text-sm" placeholder="08:00" />
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm" for="defaultClose">Cierre (default):</label>
              <input id="defaultClose" type="time" class="p-2 border rounded-lg text-sm" placeholder="18:00" />
            </div>
            <label class="text-sm flex items-center gap-2">
              <input id="useGeo" type="checkbox" class="w-4 h-4 rounded">
              Usar mi ubicaci√≥n como inicio
            </label>
            <label class="text-sm flex items-center gap-2">
              <input id="circular" type="checkbox" class="w-4 h-4 rounded">
              Ruta circular
            </label>
            <label class="text-sm flex items-center gap-2">
              <input id="enforceWindows" type="checkbox" class="w-4 h-4 rounded" checked>
              Respetar ventanas horarias
            </label>
          </div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="oneClick" class="px-4 py-2 rounded-xl bg-sky-700 text-white shadow hover:bg-sky-800">Pegar y Optimizar</button>
            <button id="updateBtn" class="px-4 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600">Actualizar</button>
            <button id="clearBtn" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">Limpiar</button>
          </div>
        </div>

        <!-- Tabla editable -->
        <div id="inputTableWrap" class="bg-white rounded-2xl shadow p-4 sm:p-5 hidden">
          <h2 class="text-lg font-semibold mb-3">Puntos detectados</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs md:text-sm">
              <thead>
                <tr class="text-left text-slate-600">
                  <th class="py-2 pr-3">#</th>
                  <th class="py-2 pr-3">Local</th>
                  <th class="py-2 pr-3">Direcci√≥n</th>
                  <th class="py-2 pr-3">Lat</th>
                  <th class="py-2 pr-3">Lng</th>
                  <th class="py-2 pr-3">Precisi√≥n</th>
                  <th class="py-2 pr-3">Estad√≠a</th>
                  <th class="py-2 pr-3">Abre</th>
                  <th class="py-2 pr-3">Cierra</th>
                </tr>
              </thead>
              <tbody id="inputTable"></tbody>
            </table>
          </div>
          <div class="mt-3 text-xs text-slate-500">
            Pod√©s editar <strong>Local</strong>, <strong>Abre/Cierra</strong> y <strong>Estad√≠a</strong>. El cronograma usa estos valores.
          </div>
        </div>
      </div>

      <!-- Columna derecha: estado, guardar/cargar, links -->
      <aside class="xl:col-span-1 space-y-6">
        <div class="bg-white rounded-2xl shadow p-4 sm:p-5">
          <h3 class="font-semibold mb-2">Estado</h3>
          <div id="status" class="text-xs text-slate-500">Esperando entradas‚Ä¶</div>

          <h3 class="font-semibold mt-4 mb-2">Resultados</h3>
          <div id="results" class="text-sm space-y-2"><p class="text-slate-500">A√∫n sin resultados.</p></div>
          <div class="mt-4 flex flex-col gap-2">
            <button id="copyOrder" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">Copiar orden</button>
            <button id="exportCsv" class="px-3 py-2 rounded-xl bg-sky-700 text-white hover:bg-sky-800">Exportar CSV</button>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow p-4 sm:p-5">
          <h3 class="font-semibold mb-2">Rutas guardadas</h3>
          <div class="grid grid-cols-1 gap-2">
            <input id="routeName" type="text" class="p-2 border rounded-lg text-sm" placeholder="Nombre de la ruta" />
            <div class="flex flex-wrap gap-2">
              <button id="saveNamed" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Guardar con nombre</button>
              <button id="updateNamed" class="px-3 py-2 rounded-lg bg-emerald-100 text-emerald-900 hover:bg-emerald-200">Actualizar</button>
              <button id="syncNow" class="px-3 py-2 rounded-lg bg-sky-100 text-sky-900 hover:bg-sky-200">Sincronizar ahora</button>
            </div>
            <div class="flex items-center gap-2 mt-2">
              <select id="savedSelect" class="flex-1 p-2 border rounded-lg text-sm"></select>
            </div>
            <div class="flex flex-wrap gap-2 mt-1">
              <button id="loadNamed" class="px-3 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900">Cargar</button>
              <button id="renameNamed" class="px-3 py-2 rounded-lg bg-slate-200 text-slate-900 hover:bg-slate-300">Renombrar</button>
              <button id="deleteNamed" class="px-3 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Borrar</button>
              <button id="exportNamed" class="px-3 py-2 rounded-lg bg-sky-50 text-sky-900 hover:bg-sky-100">Exportar JSON</button>
              <label class="px-3 py-2 rounded-lg bg-sky-50 text-sky-900 hover:bg-sky-100 cursor-pointer">
                Importar JSON
                <input id="importNamed" type="file" accept="application/json" class="hidden" />
              </label>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow p-4 sm:p-5">
          <h3 class="font-semibold mb-2">Enlaces de navegaci√≥n</h3>
          <div id="dirLinks" class="text-sm space-y-2"><p class="text-slate-500">Se generan links a Google Maps por tramos.</p></div>
        </div>
      </aside>
    </section>
  </div>

  <!-- L√≥gica de la app -->
  <script src="app.js?v=15"></script>

  <!-- Geocoder -->
  <script>
    window.GEOCODER = { provider: 'opencage', key: 'a24210fb3d144afc8d35ad8d5e339879' };
  </script>

  <!-- Firebase + login obligatorio (id√©ntico al anterior) -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, inMemoryPersistence,
           GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDocs, collection, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const qs = new URLSearchParams(location.search);
  const DEBUG = qs.get('debug') === '1';
  const dPanel = document.getElementById('debugPanel');
  const dLog = document.getElementById('debugLog');
  function dbg(...args){ if(!DEBUG) return; dPanel.style.display='block'; const line = args.map(a=> (typeof a==='object'? JSON.stringify(a): String(a))).join(' '); dLog.textContent += `\n${new Date().toISOString().slice(11,19)} ${line}`; dLog.scrollTop = dLog.scrollHeight; console.log('[DBG]', ...args); }

  const firebaseConfig = {
    apiKey: "AIzaSyBMo1tBOmXVhY6QwgWbzvfAndltp9k4NZk",
    authDomain: "rutas-da064.firebaseapp.com",
    projectId: "rutas-da064",
    storageBucket: "rutas-da064.appspot.com",
    messagingSenderId: "126930065003",
    appId: "1:126930065003:web:1a40af65ab7f6b9afe832e"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  window._firebase = { db, auth, onAuthStateChanged, doc, setDoc, getDocs, collection, updateDoc, deleteDoc };

  const gate = document.getElementById('authGate');
  const btn  = document.getElementById('googleSignIn');
  const err  = document.getElementById('authError');

  function showGate(msg=''){
    gate.style.display='flex';
    gate.classList.remove('hidden');
    if(msg){ err.textContent=msg; err.classList.remove('hidden'); }
  }
  function hideGate(){
    gate.style.display='none';
    gate.classList.add('hidden');
    err.classList.add('hidden');
    err.textContent='';
  }

  const isIOS = /iPad|iPhone|iPod/i.test(navigator.userAgent);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  dbg('UA', navigator.userAgent, {isIOS, isSafari, host: location.host});

  // --- Persistencia: local por defecto, pero en iOS/Safari caemos a inMemory
  try {
    if (isIOS || isSafari) {
      await setPersistence(auth, inMemoryPersistence); // evita cookies bloqueadas por ITP
      dbg('setPersistence inMemory (iOS/Safari) OK');
    } else {
      await setPersistence(auth, browserLocalPersistence);
      dbg('setPersistence local OK');
    }
  } catch(e){
    dbg('setPersistence error', e?.code||e);
    try {
      await setPersistence(auth, inMemoryPersistence);
      dbg('fallback -> inMemory OK');
    } catch(e2){ dbg('fallback inMemory error', e2?.code||e2); }
  }

  const provider = new GoogleAuthProvider();
  // En algunos Safari/iOS, prompt extra puede interferir; lo usamos solo si NO es iOS/Safari
  if (!(isIOS || isSafari)) provider.setCustomParameters({ prompt:'select_account' });

  const REDIRECT_FLAG = 'authRedirectPending';
  const wasRedirecting = sessionStorage.getItem(REDIRECT_FLAG) === '1';
  if (wasRedirecting) { hideGate(); dbg('Flag pending redirect -> hide gate'); }

  async function tryGetRedirectResult(tag){
    try {
      const rr = await getRedirectResult(auth);
      if (rr?.user) { hideGate(); dbg(`${tag} getRedirectResult -> user`, {uid: rr.user.uid}); return true; }
      dbg(`${tag} getRedirectResult -> no user`);
      return false;
    } catch (e) {
      dbg(`${tag} getRedirectResult error`, e?.code||e);
      if (e?.code === 'auth/unauthorized-domain') {
        showGate('Dominio no autorizado en Firebase Auth. Agregalo en Authentication ‚Üí Settings ‚Üí Authorized domains.');
      }
      return false;
    }
  }

  // Loop de reintento (extendido) para iOS/Safari
  async function settleRedirectIfNeeded(){
    if (!(isIOS || isSafari) || !wasRedirecting) return;
    hideGate();
    err.textContent = 'Completando inicio de sesi√≥n‚Ä¶';
    err.classList.remove('hidden');
    const maxMs = 12000; const step = 600; // 12s
    let elapsed = 0;
    while (elapsed <= maxMs && !auth.currentUser) {
      const ok = await tryGetRedirectResult('loop');
      if (ok || auth.currentUser) break;
      await new Promise(r=>setTimeout(r, step));
      elapsed += step; dbg('retry...', elapsed);
    }
    if (auth.currentUser) { err.classList.add('hidden'); hideGate(); }
  }

  await tryGetRedirectResult('initial');
  await settleRedirectIfNeeded();
  sessionStorage.removeItem(REDIRECT_FLAG);

  onAuthStateChanged(auth, (user) => {
    dbg('onAuthStateChanged', !!user, user?.uid);
    if (user && !user.isAnonymous) { hideGate(); window.cloudSyncToLocal?.(); }
    else { showGate(); }
  });

  btn?.addEventListener('click', async () => {
    err.classList.add('hidden'); err.textContent='';
    const useRedirect = true; // forzamos redirect siempre en iOS/Safari
    try {
      if (useRedirect) {
        sessionStorage.setItem(REDIRECT_FLAG, '1');
        dbg('signInWithRedirect ...');
        await signInWithRedirect(auth, provider);
      } else {
        dbg('signInWithPopup ...');
        await signInWithPopup(auth, provider);
      }
    } catch (e) {
      dbg('signIn error', e?.code||e);
      sessionStorage.setItem(REDIRECT_FLAG, '1');
      try { await signInWithRedirect(auth, provider); } catch(e2){ dbg('redirect fallback failed', e2?.code||e2); }
    }
  });

  window.addEventListener('pageshow', async (ev) => {
    if (isIOS || ev.persisted) {
      dbg('pageshow (persisted=', !!ev.persisted, ') currentUser=', !!auth.currentUser);
      if (!auth.currentUser) { await tryGetRedirectResult('pageshow'); }
    }
  });

  document.addEventListener('visibilitychange', async () => {
    if (!document.hidden && !auth.currentUser) { dbg('visibilitychange -> retry'); await tryGetRedirectResult('visibility'); }
  });
</script>

  <!-- Service Worker -->
  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js?v=15'); });
    }
  </script>
  
  <!-- Debug panel (se muestra con ?debug=1) -->
  <div id="debugPanel" style="display:none; position:fixed; bottom:8px; right:8px; z-index:99999; max-width:90vw;">
    <div style="background:#0b1220;color:#cde3ff;border:1px solid #122c5a;border-radius:10px;padding:10px; font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; box-shadow:0 6px 20px rgba(0,0,0,.25)">
      <div style="font-weight:700;margin-bottom:6px">Auth Debug</div>
      <pre id="debugLog" style="margin:0;white-space:pre-wrap;max-height:40vh;overflow:auto"></pre>
    </div>
  </div>

  <!-- L√≥gica de la app -->
  <script src="app.js?v=15"></script>

  <!-- Geocoder -->
  <script>
    window.GEOCODER = { provider: 'opencage', key: 'a24210fb3d144afc8d35ad8d5e339879' };
  </script>

  <!-- Firebase + login (versi√≥n reforzada iOS/Safari con panel de debug) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const qs = new URLSearchParams(location.search);
    const DEBUG = qs.get('debug') === '1';
    const dPanel = document.getElementById('debugPanel');
    const dLog = document.getElementById('debugLog');
    function dbg(...args){ if(!DEBUG) return; dPanel.style.display='block'; const line = args.map(a=> (typeof a==='object'? JSON.stringify(a): String(a))).join(' '); dLog.textContent += `
${new Date().toISOString().slice(11,19)} ${line}`; dLog.scrollTop = dLog.scrollHeight; console.log('[DBG]', ...args); }

    const firebaseConfig = {
      apiKey: "AIzaSyBMo1tBOmXVhY6QwgWbzvfAndltp9k4NZk",
      authDomain: "rutas-da064.firebaseapp.com",
      projectId: "rutas-da064",
      storageBucket: "rutas-da064.appspot.com",
      messagingSenderId: "126930065003",
      appId: "1:126930065003:web:1a40af65ab7f6b9afe832e"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    window._firebase = { db, auth, onAuthStateChanged, doc, setDoc, getDocs, collection, updateDoc, deleteDoc };

    const gate = document.getElementById('authGate');
    const btn  = document.getElementById('googleSignIn');
    const err  = document.getElementById('authError');

    function showGate(msg=''){
      gate.style.display='flex';
      gate.classList.remove('hidden');
      if(msg){ err.textContent=msg; err.classList.remove('hidden'); }
    }
    function hideGate(){
      gate.style.display='none';
      gate.classList.add('hidden');
      err.classList.add('hidden');
      err.textContent='';
    }

    try { await setPersistence(auth, browserLocalPersistence); dbg('setPersistence OK'); } catch(e){ dbg('setPersistence error', e?.code||e); }

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt:'select_account' });

    const isIOS = /iPad|iPhone|iPod/i.test(navigator.userAgent);
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    dbg('UA', navigator.userAgent, {isIOS, isSafari, host: location.host});

    const REDIRECT_FLAG = 'authRedirectPending';
    if (sessionStorage.getItem(REDIRECT_FLAG) === '1') { hideGate(); dbg('Flag pending redirect -> hide gate'); }

    // Procesar resultado de redirect al cargar
    try {
      const rr = await getRedirectResult(auth);
      if (rr?.user) { hideGate(); dbg('getRedirectResult -> user', {uid: rr.user.uid}); }
      sessionStorage.removeItem(REDIRECT_FLAG);
    } catch (e) {
      dbg('getRedirectResult error', e?.code||e);
      if (e?.code === 'auth/unauthorized-domain') {
        showGate('Dominio no autorizado en Firebase Auth. Agregalo en Authentication ‚Üí Settings ‚Üí Authorized domains.');
      }
    }

    onAuthStateChanged(auth, (user) => {
      dbg('onAuthStateChanged', !!user, user?.uid);
      if (user && !user.isAnonymous) { hideGate(); window.cloudSyncToLocal?.(); }
      else { showGate(); }
    });

    btn?.addEventListener('click', async () => {
      err.classList.add('hidden'); err.textContent='';
      const useRedirect = isIOS || isSafari;
      try {
        if (useRedirect) {
          sessionStorage.setItem(REDIRECT_FLAG, '1');
          dbg('signInWithRedirect ...');
          await signInWithRedirect(auth, provider);
        } else {
          dbg('signInWithPopup ...');
          await signInWithPopup(auth, provider);
        }
      } catch (e) {
        dbg('signIn error', e?.code||e);
        sessionStorage.setItem(REDIRECT_FLAG, '1');
        try { await signInWithRedirect(auth, provider); } catch(e2){ dbg('redirect fallback failed', e2?.code||e2); }
      }
    });

    // iOS: al volver del redirect o desde el background, reintentar lectura
    window.addEventListener('pageshow', async (ev) => {
      if (isIOS || ev.persisted) {
        dbg('pageshow (persisted=', !!ev.persisted, ') currentUser=', !!auth.currentUser);
        if (!auth.currentUser) {
          try { const rr = await getRedirectResult(auth); if (rr?.user) { hideGate(); dbg('pageshow -> got user'); } } catch {}
        }
      }
    });

    document.addEventListener('visibilitychange', async () => {
      if (!document.hidden && !auth.currentUser) {
        dbg('visibilitychange -> retry getRedirectResult');
        try { const rr = await getRedirectResult(auth); if (rr?.user) hideGate(); } catch {}
      }
    });
  </script>

  <!-- Service Worker -->
  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js?v=15'); });
    }
  </script>
</body>
</html>
